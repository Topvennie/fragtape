name: Migration order

on:
  pull_request:
    paths:
      - "db/migrations/**"
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  check-migration-timestamp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify that new migrations are the most recent
        shell: bash
        run: |
          set -euo pipefail

          MIGRATION_DIR="db/migrations/"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="origin/${{ github.base_ref }}"
            HEAD_REF="${{ github.sha }}"
            echo "PR: comparing HEAD with base (${BASE_REF})."
          else
            BASE_REF="${{ github.before }}"
            HEAD_REF="${{ github.sha }}"
            if [[ "$BASE_REF" == "0000000000000000000000000000000000000000" ]]; then
              echo "First push detected. Skipping migration order check."
              exit 0
            fi
            echo "Push: comparing ${HEAD_REF} with previous (${BASE_REF})."
          fi

          LATEST_BASE_TIMESTAMP="$(git ls-tree --name-only "$BASE_REF" "$MIGRATION_DIR" 2>/dev/null \
            | xargs -n 1 basename \
            | cut -d '_' -f1 \
            | sort -nr \
            | head -n 1 || true)"

          LATEST_BASE_TIMESTAMP="${LATEST_BASE_TIMESTAMP:-0}"
          echo "Latest base migration timestamp: $LATEST_BASE_TIMESTAMP"

          ADDED_FILES="$(git diff --name-only --diff-filter=A "$BASE_REF" "$HEAD_REF" -- "$MIGRATION_DIR" || true)"
          if [[ -z "$ADDED_FILES" ]]; then
            echo "No new migration files added. OK."
            exit 0
          fi

          echo "New migration files:"
          echo "$ADDED_FILES"

          HAS_ERROR=false

          while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            filename="$(basename "$file")"
            timestamp="$(echo "$filename" | cut -d'_' -f1)"

            echo "Checking $filename (timestamp $timestamp)"

            if ! [[ "$timestamp" =~ ^[0-9]+$ ]]; then
              echo "::error file=$file::Invalid timestamp prefix; must be numeric."
              HAS_ERROR=true
              continue
            fi

            if [[ "$timestamp" -le "$LATEST_BASE_TIMESTAMP" ]]; then
              echo "::error file=$file::Timestamp '$timestamp' must be greater than base '$LATEST_BASE_TIMESTAMP'."
              HAS_ERROR=true
            fi
          done <<< "$ADDED_FILES"

          $HAS_ERROR && exit 1

          echo "Migration order OK."
